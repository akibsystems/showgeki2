# ScriptDirector コンポーネント 詳細設計書

## 1. 概要

### 1.1 目的
`ScriptDirector`は、MulmoScript形式の動画台本を直感的に編集するための専用コンポーネントです。従来のテキストベース`ScriptEditor`と異なり、GUIベースで脚本の構造的編集を可能にします。

### 1.2 対象ユーザー
- スマートフォンユーザー（主要ターゲット）
- JSON形式に慣れていない一般ユーザー
- 直感的な編集を求めるクリエイター

### 1.3 設計方針
- **直感性**: 技術知識不要で操作可能
- **モバイルファースト**: スマートフォンでの使いやすさを最優先
- **演劇的UI**: showgeki2のシェイクスピア風コンセプトに合致
- **リアルタイム反映**: 変更が即座にプレビュー可能

## 2. 機能要件

### 2.1 基本機能
| 機能 | 説明 | 優先度 |
|------|------|--------|
| タイトル編集 | 動画タイトルの入力・編集 | 高 |
| 画像設定管理 | スタイル選択・顔参照画像管理 | 高 |
| 音声設定管理 | 話者の追加・削除・編集 | 高 |
| ビート編集 | 台詞・画像プロンプト・話者選択 | 高 |
| 順序操作 | ビートの並び替え・追加・削除 | 高 |

### 2.2 高度機能
| 機能 | 説明 | 優先度 |
|------|------|--------|
| 顔参照管理 | 画像アップロード・URL指定 | 中 |
| プリセット | よく使用される設定の保存 | 低 |
| バリデーション | 入力値の検証・エラー表示 | 中 |

## 3. UI/UX設計

### 3.1 全体レイアウト構造

```
Desktop Layout:
┌─────────────────────────────────────────────────────┐
│ Header: タイトル編集エリア                          │
├─────────────────────────────────────────────────────┤
│ ┌─────────────────┐ ┌─────────────────────────────┐ │
│ │   画像設定      │ │        音声設定             │ │
│ │   パネル        │ │        パネル               │ │
│ │                 │ │                             │ │
│ └─────────────────┘ └─────────────────────────────┘ │
├─────────────────────────────────────────────────────┤
│ ビート編集エリア                                    │
│ ┌─ Beat 1 ─────────────────────────────────────────┐ │
│ │ [話者選択] [テキスト] [画像プロンプト]          │ │
│ └─────────────────────────────────────────────────┘ │
│ ┌─ Beat 2 ─────────────────────────────────────────┐ │
│ │ [話者選択] [テキスト] [画像プロンプト]          │ │
│ └─────────────────────────────────────────────────┘ │
│ [+ 新しいビートを追加]                              │
└─────────────────────────────────────────────────────┘

Mobile Layout:
┌─────────────────┐
│ タイトル編集    │
├─────────────────┤
│ 📱 Tab Navigation │
│ [画像][音声][台本] │
├─────────────────┤
│                 │
│ アクティブタブ  │
│ コンテンツ      │
│                 │
│                 │
└─────────────────┘
```

### 3.2 各セクション詳細設計

#### 3.2.1 ヘッダー - タイトル編集
```tsx
┌─ 作品タイトル ─────────────────────────────────────┐
│ ┌─────────────────────────────────────────────────┐ │
│ │ 夢への第一歩                                    │ │
│ └─────────────────────────────────────────────────┘ │
│ プレースホルダー: "動画のタイトルを入力してください" │
└─────────────────────────────────────────────────────┘
```

#### 3.2.2 画像設定パネル
```tsx
┌─ 🎨 画像設定 ───────────────────────────────────────┐
│ スタイル:                                           │
│ ┌─────────────────────────────────────────────────┐ │
│ │ ジブリ風アニメ、ソフトパステルカラー... ▼       │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 🎭 顔参照画像 (オプション):                         │
│ ┌─────────────────────────────────────────────────┐ │
│ │ [➕ 顔参照を追加]                                │ │
│ │                                                 │ │
│ │ 📷 村口                               [✏️] [🗑️] │ │
│ │    📂 /path/to/muraguchi.png                    │ │
│ │                                                 │ │
│ │ 📷 大谷                               [✏️] [🗑️] │ │
│ │    🔗 https://example.com/otani.jpg             │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘

プリセット選択肢:
- ジブリ風アニメ、ソフトパステルカラー、繊細な線画、シネマティック照明
- リアル写真、高解像度、プロフェッショナル照明
- 油絵風、古典的な絵画スタイル、豊かな色彩
- 水彩画風、柔らかいタッチ、透明感のある色合い
- [カスタム入力]
```

#### 3.2.3 音声設定パネル
```tsx
┌─ 🎤 音声設定 ───────────────────────────────────────┐
│ プロバイダー: OpenAI (固定)                         │
│                                                     │
│ 🎭 話者設定:                                        │
│ ┌─────────────────────────────────────────────────┐ │
│ │ [➕ 話者を追加]                                  │ │
│ │                                                 │ │
│ │ 🎤 Narrator                           [✏️] [🗑️] │ │
│ │    音声: shimmer ▼   表示名: 語り手             │ │
│ │                                                 │ │
│ │ 🎤 Character                          [✏️] [🗑️] │ │
│ │    音声: alloy ▼     表示名: 主人公             │ │
│ │                                                 │ │
│ │ 🎤 WiseCharacter                      [✏️] [🗑️] │ │
│ │    音声: echo ▼      表示名: 賢者               │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘

音声選択肢: alloy, echo, fable, nova, onyx, shimmer
```

#### 3.2.4 ビート編集エリア
```tsx
┌─ 📝 台本編集 ───────────────────────────────────────┐
│ [➕ 新しいビートを追加]                              │
│                                                     │
│ ┌─ 🎬 第1幕 ──────────────────────────────────────┐ │
│ │ 話者: [Narrator ▼]                              │ │
│ │ 台詞:                                           │ │
│ │ ┌─────────────────────────────────────────────┐ │ │
│ │ │ 昔々、ある村に夢を持った若者がいました...   │ │ │
│ │ └─────────────────────────────────────────────┘ │ │
│ │ 画像の指示:                                     │ │
│ │ ┌─────────────────────────────────────────────┐ │ │
│ │ │ 夕日に照らされた美しい村の風景...           │ │ │
│ │ └─────────────────────────────────────────────┘ │ │
│ │ 顔参照: ☐ 村口  ☐ 大谷                         │ │
│ │ [⬆️] [⬇️] [🗑️]                                   │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ ┌─ 🎬 第2幕 ──────────────────────────────────────┐ │
│ │ 話者: [Character ▼]                             │ │
│ │ 台詞:                                           │ │
│ │ ┌─────────────────────────────────────────────┐ │ │
│ │ │ 僕には大きな夢があるんだ...                 │ │ │
│ │ └─────────────────────────────────────────────┘ │ │
│ │ 画像の指示:                                     │ │
│ │ ┌─────────────────────────────────────────────┐ │ │
│ │ │ 希望に満ちた表情の主人公のポートレート...   │ │ │
│ │ └─────────────────────────────────────────────┘ │ │
│ │ 顔参照: ☑️ 村口  ☐ 大谷                         │ │
│ │ [⬆️] [⬇️] [🗑️]                                   │ │
│ └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 3.3 モーダルダイアログ設計

#### 3.3.1 顔参照追加モーダル
```tsx
┌─ 🎭 顔参照画像を追加 ───────────────────────────────┐
│ キャラクター名:                                     │
│ ┌─────────────────────────────────────────────────┐ │
│ │ 村口                                            │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 画像ソース:                                         │
│ ⚪ ファイルアップロード                              │
│   [📁 ファイルを選択]  選択されていません           │
│ ⚪ URL指定                                          │
│   ┌───────────────────────────────────────────────┐ │
│   │ https://example.com/image.jpg                 │ │
│   └───────────────────────────────────────────────┘ │
│                                                     │
│ プレビュー:                                         │
│ ┌─────────────────┐                               │
│ │     [画像]      │  ← 200x200px プレビュー        │
│ │   プレビュー    │                               │
│ └─────────────────┘                               │
│                                                     │
│ [キャンセル] [追加する]                             │
└─────────────────────────────────────────────────────┘
```

#### 3.3.2 話者追加モーダル
```tsx
┌─ 🎤 話者を追加 ─────────────────────────────────────┐
│ 話者ID (英数字のみ):                                │
│ ┌─────────────────────────────────────────────────┐ │
│ │ NewCharacter                                    │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 音声:                                               │
│ ┌─────────────────────────────────────────────────┐ │
│ │ shimmer ▼                                       │ │
│ └─────────────────────────────────────────────────┘ │
│                                                     │
│ 表示名:                                             │
│ 日本語: ┌─────────────────────────────────────────┐ │
│         │ 新キャラクター                          │ │
│         └─────────────────────────────────────────┘ │
│ 英語:   ┌─────────────────────────────────────────┐ │
│         │ New Character                           │ │
│         └─────────────────────────────────────────┘ │
│                                                     │
│ [キャンセル] [追加する]                             │
└─────────────────────────────────────────────────────┘
```

## 4. 技術仕様

### 4.1 TypeScript インターフェース

```typescript
// コンポーネントProps
interface ScriptDirectorProps {
  script: Mulmoscript;
  onChange: (script: Mulmoscript) => void;
  onSave?: () => void;
  isReadOnly?: boolean;
  className?: string;
}

// 内部状態管理
interface ScriptDirectorState {
  // UI状態
  activeTab: 'image' | 'speech' | 'beats';
  editingBeat: number | null;
  draggedBeat: number | null;
  
  // モーダル状態
  showImageModal: boolean;
  showSpeakerModal: boolean;
  editingImage: string | null;
  editingSpeaker: string | null;
  
  // フォーム状態
  imageForm: ImageFormData;
  speakerForm: SpeakerFormData;
  
  // バリデーション
  errors: ValidationErrors;
}

// フォームデータ型
interface ImageFormData {
  name: string;
  sourceType: 'file' | 'url';
  file: File | null;
  url: string;
  preview: string | null;
}

interface SpeakerFormData {
  id: string;
  voiceId: VoiceId;
  displayName: {
    ja: string;
    en: string;
  };
}

// バリデーション型
interface ValidationErrors {
  title?: string;
  speakers?: Record<string, string>;
  beats?: Record<number, BeatErrors>;
  images?: Record<string, string>;
}

interface BeatErrors {
  text?: string;
  speaker?: string;
  imagePrompt?: string;
}

// OpenAI音声ID
type VoiceId = 'alloy' | 'echo' | 'fable' | 'nova' | 'onyx' | 'shimmer';
```

### 4.2 コンポーネント構造

```typescript
ScriptDirector/
├── index.tsx                 // メインコンポーネント
├── components/
│   ├── TitleEditor.tsx       // タイトル編集
│   ├── ImageSettings.tsx     // 画像設定パネル
│   ├── SpeechSettings.tsx    // 音声設定パネル
│   ├── BeatsEditor.tsx       // ビート編集エリア
│   ├── BeatItem.tsx          // 個別ビート編集
│   └── modals/
│       ├── ImageModal.tsx    // 顔参照追加モーダル
│       └── SpeakerModal.tsx  // 話者追加モーダル
├── hooks/
│   ├── useScriptDirector.ts  // メイン状態管理
│   ├── useImageManager.ts    // 画像管理
│   ├── useSpeakerManager.ts  // 話者管理
│   └── useBeatsManager.ts    // ビート管理
├── utils/
│   ├── validation.ts         // バリデーション関数
│   ├── fileUtils.ts          // ファイル処理
│   └── dragAndDrop.ts        // ドラッグ&ドロップ
└── styles/
    └── ScriptDirector.module.css
```

### 4.3 主要フック設計

```typescript
// メイン状態管理フック
export function useScriptDirector(
  initialScript: Mulmoscript,
  onChange: (script: Mulmoscript) => void
) {
  const [script, setScript] = useState<Mulmoscript>(initialScript);
  const [state, setState] = useState<ScriptDirectorState>(initialState);
  
  // タイトル更新
  const updateTitle = useCallback((title: string) => {
    const newScript = { ...script, title };
    setScript(newScript);
    onChange(newScript);
  }, [script, onChange]);
  
  // 画像設定更新
  const updateImageParams = useCallback((imageParams: ImageParams) => {
    const newScript = { ...script, imageParams };
    setScript(newScript);
    onChange(newScript);
  }, [script, onChange]);
  
  // その他の更新関数...
  
  return {
    script,
    state,
    updateTitle,
    updateImageParams,
    // その他のアクション...
  };
}

// 画像管理フック
export function useImageManager(
  images: Record<string, ImageReference>,
  onUpdate: (images: Record<string, ImageReference>) => void
) {
  // 画像追加・削除・編集ロジック
}

// 話者管理フック
export function useSpeakerManager(
  speakers: Record<string, Speaker>,
  onUpdate: (speakers: Record<string, Speaker>) => void
) {
  // 話者追加・削除・編集ロジック
}

// ビート管理フック
export function useBeatsManager(
  beats: Beat[],
  onUpdate: (beats: Beat[]) => void
) {
  // ビート追加・削除・並び替えロジック
}
```

## 5. データフロー

### 5.1 状態更新フロー
```
User Input → Hook → State Update → Script Update → Parent Callback → UI Re-render
```

### 5.2 ファイルアップロードフロー
```
File Select → File Validation → Preview Generation → Temporary Storage → Form Submit → Image Reference Creation
```

### 5.3 バリデーションフロー
```
Input Change → Real-time Validation → Error State Update → UI Error Display
```

## 6. レスポンシブ対応

### 6.1 ブレークポイント
```css
/* Mobile First */
.script-director {
  /* モバイル用スタイル */
}

/* Tablet */
@media (min-width: 768px) {
  .script-director {
    /* タブレット用スタイル */
  }
}

/* Desktop */
@media (min-width: 1024px) {
  .script-director {
    /* デスクトップ用スタイル */
  }
}
```

### 6.2 モバイル専用機能
- タブナビゲーション
- スワイプジェスチャー
- タッチフレンドリーなボタンサイズ
- 仮想キーボード対応

## 7. アクセシビリティ

### 7.1 対応要件
- キーボード操作対応
- スクリーンリーダー対応
- 適切なARIAラベル
- カラーコントラスト確保

### 7.2 実装例
```tsx
<button
  aria-label="ビートを上に移動"
  onClick={() => moveBeat(index, 'up')}
  disabled={index === 0}
>
  ⬆️
</button>
```

## 8. 実装フェーズ

### Phase 1: 基本構造 (1週間)
- [ ] コンポーネント骨格作成
- [ ] 基本的な状態管理
- [ ] タイトル編集機能

### Phase 2: コア機能 (2週間)
- [ ] 音声設定管理
- [ ] ビート編集機能
- [ ] 基本バリデーション

### Phase 3: 高度機能 (1週間)
- [ ] 画像設定・顔参照機能
- [ ] ドラッグ&ドロップ
- [ ] モーダルダイアログ

### Phase 4: 最適化 (1週間)
- [ ] レスポンシブ対応
- [ ] パフォーマンス最適化
- [ ] アクセシビリティ対応

## 9. テスト戦略

### 9.1 単体テスト
- 各フックの動作テスト
- バリデーション関数テスト
- ユーティリティ関数テスト

### 9.2 統合テスト
- コンポーネント間の連携テスト
- ファイルアップロード処理テスト
- 状態管理フローテスト

### 9.3 E2Eテスト
- 脚本作成完全フローテスト
- モバイル端末でのタッチ操作テスト