# 🎯 Showgeki2 テスト品質改善計画

## 📋 概要

本ドキュメントは、Showgeki2プロジェクトのテスト品質向上を目的とした改善計画書です。現在のテスト実装状況を分析し、優先度に基づいた具体的なアクションプランを提供します。

**対象期間**: 4週間  
**総投資工数**: 60-80時間  
**期待効果**: 開発効率30%向上、バグ発見率70%向上  
**現在のステータス**: ✅ **Phase 1完了** (2024年6月27日)

---

## 🔥 Phase 1: 基盤安定化 (Week 1)

### **施策1: uid.test.ts ブラウザ環境モック修正**

**現状**: 26/63件のテストが失敗 (localStorage/cookieモック不備)

#### 📝 詳細チェックリスト

**Step 1: 問題分析**
- [ ] 失敗しているテストケースの詳細確認
- [ ] 現在のモック実装の問題点特定
- [ ] ブラウザAPIの期待動作調査

**Step 2: localStorage モック修正**
- [ ] `mockLocalStorage.getItem` の戻り値修正
- [ ] `mockLocalStorage.setItem` の動作確認機能追加
- [ ] localStorage 容量制限エラーのシミュレーション実装

**Step 3: Cookie モック実装**
- [ ] `document.cookie` setter/getter の実装
- [ ] URLエンコーディング処理の追加
- [ ] Cookieセキュリティ属性の検証機能

**Step 4: SSR環境テスト修正**
- [ ] `window` オブジェクト削除処理の修正
- [ ] `typeof window === 'undefined'` 条件の適切な処理
- [ ] Node.js環境での動作確認

**Step 5: 検証・仕上げ**
- [ ] 全63件のテストケース実行確認
- [ ] エッジケースの追加検証
- [ ] コードレビューとリファクタリング

**完了条件**: uid.test.ts 全テスト通過 (63/63件)  
**工数見積**: 2-4時間

---

### **施策2: Supabase統合テストモック構造簡素化**

**現状**: 24/36件の統合テストが失敗 (複雑なチェーンモック)

#### 📝 詳細チェックリスト

**Step 1: 現状分析**
- [ ] 失敗パターンの分類と原因特定
- [ ] 既存モック構造の問題点洗い出し
- [ ] Supabaseクライアントの実際の動作確認

**Step 2: モックファクトリ設計**
- [ ] `createMockSupabaseTable()` 関数の設計
- [ ] クエリチェーン対応の統一インターフェース定義
- [ ] テストデータセットの事前定義構造

**Step 3: ヘルパー関数実装**
- [ ] `mockSupabaseSelect()` 実装
- [ ] `mockSupabaseInsert()` 実装
- [ ] `mockSupabaseUpdate()` 実装
- [ ] `mockSupabaseDelete()` 実装
- [ ] チェーンメソッドの適切な戻り値設定

**Step 4: テストケース更新**
- [ ] GET /api/stories テストの書き換え
- [ ] POST /api/stories テストの書き換え
- [ ] PUT /api/stories/[id] テストの書き換え
- [ ] DELETE /api/stories/[id] テストの書き換え
- [ ] ワークフロー統合テストの修正

**Step 5: 検証・最適化**
- [ ] 全36件のテストケース実行確認
- [ ] モック応答時間の最適化
- [ ] エラーケースの網羅的テスト

**完了条件**: stories.test.ts 全テスト通過 (36/36件)  
**工数見積**: 6-8時間

---

### **施策3: テストカバレッジレポート設定修正**

**現状**: sourcemap読み込みエラーでカバレッジ生成失敗

#### 📝 詳細チェックリスト

**Step 1: エラー原因特定**
- [ ] sourcemapエラーログの詳細分析
- [ ] `.next` ビルドファイルの影響確認
- [ ] vite設定とNext.js設定の競合調査

**Step 2: vitest.config.ts 最適化**
- [ ] coverage.exclude パターンの追加
- [ ] `.next/**/*` パスの除外設定
- [ ] `node_modules` 除外の強化
- [ ] sourcemap生成設定の調整

**Step 3: しきい値調整**
- [ ] 現実的なカバレッジ目標値の設定
- [ ] branches: 70% → 60% への調整検討
- [ ] functions: 80% → 75% への調整検討
- [ ] 段階的目標値の設定

**Step 4: 動作確認**
- [ ] `npm run test:coverage` の正常実行確認
- [ ] HTMLレポートの生成確認
- [ ] CI環境での動作確認

**Step 5: ドキュメント更新**
- [ ] カバレッジ実行手順の文書化
- [ ] しきい値の根拠説明
- [ ] 継続的監視プロセスの定義

**完了条件**: カバレッジレポート正常生成、HTMLレポート閲覧可能  
**工数見積**: 1-2時間

---

## ⚡ Phase 2: 機能拡張 (Week 2)

### **施策4: API Client ネットワークエラーハンドリング強化**

**現状**: 1件のネットワークエラーテスト失敗

#### 📝 詳細チェックリスト

**Step 1: 失敗テスト分析**
- [ ] 失敗しているテストケースの詳細確認
- [ ] ネットワークエラーシミュレーションの問題特定
- [ ] 期待動作と実際の動作の差分分析

**Step 2: fetchモック強化**
- [ ] ネットワークエラーの適切なシミュレーション
- [ ] `TypeError: Failed to fetch` の再現
- [ ] タイムアウトエラーの実装
- [ ] 接続拒否エラーの実装

**Step 3: リトライロジックテスト**
- [ ] 指数バックオフの動作確認
- [ ] 最大リトライ回数の検証
- [ ] リトライ対象エラーの分類テスト
- [ ] 非リトライエラーの適切な処理

**Step 4: 境界値テスト追加**
- [ ] 0秒タイムアウトのテスト
- [ ] 極大レスポンスサイズのテスト
- [ ] 不正なJSONレスポンスのテスト
- [ ] 空レスポンスの処理テスト

**Step 5: 統合シナリオテスト**
- [ ] 複数API呼び出しでの障害波及テスト
- [ ] 部分的ネットワーク障害のシミュレーション
- [ ] 復旧時の自動再試行テスト

**完了条件**: api-client.test.ts 全テスト通過 (54/54件)  
**工数見積**: 1-3時間

---

### **施策5: フロントエンドコンポーネントテスト基盤構築**

**現状**: Reactコンポーネントの未テスト状態

#### 📝 詳細チェックリスト

**Step 1: テスト戦略策定**
- [ ] 対象コンポーネントの優先度設定
- [ ] Testing Library のベストプラクティス調査
- [ ] Supabase Context モック戦略の設計

**Step 2: テスト環境セットアップ**
- [ ] `tests/components/` ディレクトリ作成
- [ ] 共通テストヘルパーの実装
- [ ] Context Provider のモック実装
- [ ] ルーターモックの設定

**Step 3: VideoPlayer コンポーネントテスト**
- [ ] 基本レンダリングテスト
- [ ] 動画再生/停止機能テスト
- [ ] エラー状態の表示テスト
- [ ] レスポンシブ動作テスト
- [ ] アクセシビリティテスト

**Step 4: ScriptEditor コンポーネントテスト**
- [ ] Monaco Editor の統合テスト
- [ ] JSON編集機能のテスト
- [ ] バリデーションエラー表示テスト
- [ ] 保存機能のテスト
- [ ] undo/redo機能のテスト

**Step 5: 共通UIコンポーネントテスト**
- [ ] Button コンポーネントテスト
- [ ] Modal コンポーネントテスト
- [ ] Toast 通知テスト
- [ ] Spinner アニメーションテスト

**完了条件**: 主要5コンポーネントのテスト実装完了  
**工数見積**: 8-12時間

---

### **施策6: 共通テストヘルパー関数群整備**

**現状**: テストコード重複、保守性低下

#### 📝 詳細チェックリスト

**Step 1: 重複パターン分析**
- [ ] 既存テストコードの重複箇所特定
- [ ] 共通化可能な処理の洗い出し
- [ ] ヘルパー関数の設計要件定義

**Step 2: ディレクトリ構造設計**
- [ ] `tests/helpers/` ディレクトリ作成
- [ ] `tests/fixtures/` データ置き場作成
- [ ] `tests/mocks/` モック関数置き場作成

**Step 3: データファクトリ実装**
- [ ] `createMockStory()` 関数実装
- [ ] `createMockUser()` 関数実装
- [ ] `createMockVideo()` 関数実装
- [ ] `createMockWorkspace()` 関数実装
- [ ] バリエーション生成オプション追加

**Step 4: アサーション関数実装**
- [ ] `expectValidStoryResponse()` 実装
- [ ] `expectErrorResponse()` 実装
- [ ] `expectAuthenticatedRequest()` 実装
- [ ] `expectValidationError()` 実装

**Step 5: 既存テスト移行**
- [ ] unit テストのヘルパー関数適用
- [ ] integration テストのヘルパー関数適用
- [ ] 重複コードの削除
- [ ] 一貫性確保のためのレビュー

**完了条件**: 既存テストの30%以上でヘルパー関数活用  
**工数見積**: 4-6時間

---

## 🎯 Phase 3: 自動化・監視 (Week 3-4)

### **施策7: E2Eテスト基盤導入**

**現状**: ユーザージャーニー全体の未検証

#### 📝 詳細チェックリスト

**Step 1: ツール選定・セットアップ**
- [ ] Playwright vs Cypress の比較検討
- [ ] Playwright インストールと初期設定
- [ ] ブラウザ環境の設定 (Chrome, Firefox, Safari)
- [ ] CI環境でのヘッドレス実行設定

**Step 2: テスト環境準備**
- [ ] `tests/e2e/` ディレクトリ作成
- [ ] テスト用データベースの分離設定
- [ ] テスト用認証ユーザーの準備
- [ ] モックサーバーの設定検討

**Step 3: 基本ジャーニーテスト実装**
- [ ] ユーザー登録フローテスト
- [ ] ログイン/ログアウトテスト
- [ ] 物語作成フローテスト
- [ ] 動画生成待機フローテスト
- [ ] 動画視聴フローテスト

**Step 4: エラーケーステスト**
- [ ] 無効な入力データでのエラー表示
- [ ] ネットワーク障害時の動作
- [ ] 認証エラーハンドリング
- [ ] APIエラー時のユーザー体験

**Step 5: パフォーマンステスト**
- [ ] ページ読み込み時間測定
- [ ] 動画生成処理時間監視
- [ ] レスポンシブ表示確認
- [ ] アクセシビリティ基準確認

**完了条件**: 主要5ジャーニーのE2Eテスト実装  
**工数見積**: 12-16時間

---

### **施策8: CI/CDパイプライン強化**

**現状**: 手動テスト実行による人的ミスリスク

#### 📝 詳細チェックリスト

**Step 1: 現状CI分析**
- [ ] 既存GitHub Actionsワークフローの確認
- [ ] 実行時間とボトルネック特定
- [ ] 失敗パターンの分析

**Step 2: テスト実行最適化**
- [ ] 並列テスト実行の設定
- [ ] テストキャッシュの活用
- [ ] 条件付きテスト実行の実装
- [ ] 失敗時の詳細ログ出力

**Step 3: 品質ゲート実装**
- [ ] PRマージ前の必須テスト設定
- [ ] カバレッジしきい値チェック
- [ ] リント・型チェックの必須化
- [ ] セキュリティスキャンの統合

**Step 4: 通知・監視設定**
- [ ] Slack通知の設定
- [ ] テスト失敗時のアラート
- [ ] カバレッジ低下の検知
- [ ] パフォーマンス劣化の監視

**Step 5: デプロイメント自動化**
- [ ] ステージング環境への自動デプロイ
- [ ] E2Eテスト後の本番デプロイ
- [ ] ロールバック機能の実装
- [ ] デプロイ成功通知

**完了条件**: 完全自動化されたCI/CDパイプライン  
**工数見積**: 6-10時間

---

### **施策9: パフォーマンステスト導入**

**現状**: 動画生成処理の性能未検証

#### 📝 詳細チェックリスト

**Step 1: ツール選定・準備**
- [ ] k6 vs JMeter の比較検討
- [ ] k6 インストールと基本設定
- [ ] Cloud Run 環境での実行準備
- [ ] 監視ダッシュボードの設定

**Step 2: 負荷テストシナリオ設計**
- [ ] 同時ユーザー数の想定設定
- [ ] API エンドポイント別の負荷分散
- [ ] 動画生成処理の負荷パターン
- [ ] データベース負荷の考慮

**Step 3: テストケース実装**
- [ ] 基本API応答時間テスト
- [ ] 段階的負荷増加テスト
- [ ] ピーク負荷持続テスト
- [ ] 異常負荷でのクラッシュテスト

**Step 4: Cloud Run 特性検証**
- [ ] コールドスタート時間測定
- [ ] スケールアウト特性確認
- [ ] リソース使用率監視
- [ ] 費用対効果の分析

**Step 5: 継続監視設定**
- [ ] 本番環境での定期実行
- [ ] しきい値アラートの設定
- [ ] トレンド分析レポート
- [ ] 改善提案の自動生成

**完了条件**: パフォーマンス監視体制確立  
**工数見積**: 8-12時間

---

### **施策10: セキュリティテスト強化**

**現状**: 認証・認可の境界値未検証

#### 📝 詳細チェックリスト

**Step 1: セキュリティ要件定義**
- [ ] OWASP Top 10 対策状況確認
- [ ] JWT認証の脆弱性調査
- [ ] Supabase RLS設定の検証
- [ ] API エンドポイントの権限確認

**Step 2: 自動スキャン導入**
- [ ] OWASP ZAP の設定
- [ ] CI パイプラインへの統合
- [ ] 脆弱性レポートの自動生成
- [ ] False Positive の除外設定

**Step 3: 認証・認可テスト**
- [ ] JWT トークン改ざんテスト
- [ ] 有効期限切れトークンテスト
- [ ] 不正な権限昇格テスト
- [ ] セッション管理の検証

**Step 4: インジェクション攻撃テスト**
- [ ] SQLインジェクション対策確認
- [ ] XSS脆弱性の検証
- [ ] CSRF攻撃対策の確認
- [ ] NoSQLインジェクション対策

**Step 5: データ保護検証**
- [ ] 個人情報の適切な保護確認
- [ ] ログ出力での機密情報確認
- [ ] 通信暗号化の検証
- [ ] バックアップデータの保護

**完了条件**: セキュリティテスト自動化完了  
**工数見積**: 10-15時間

---

## 📊 進捗管理・成功指標

### **週次マイルストーン**

**Week 1 完了条件:**
- [ ] uid.test.ts: 63/63件通過
- [ ] stories.test.ts: 36/36件通過  
- [ ] カバレッジレポート正常生成

**Week 2 完了条件:**
- [ ] api-client.test.ts: 54/54件通過
- [ ] フロントエンド5コンポーネントテスト実装
- [ ] テストヘルパー関数30%活用

**Week 3-4 完了条件:**
- [ ] E2E 5ジャーニーテスト実装
- [ ] CI/CD完全自動化
- [ ] パフォーマンス監視確立
- [ ] セキュリティテスト自動化

### **品質メトリクス目標**

```
📈 テストカバレッジ: 60% → 85%
📈 CI/CD実行時間: 現状 → 50%短縮
📈 テスト実行頻度: 手動 → 全PR自動実行
📈 バグ検出率: 現状 → 70%向上
📈 リリース信頼性: 現状 → リスクフリー
```

### **継続的改善プロセス**

1. **日次**: テスト実行結果確認
2. **週次**: カバレッジトレンド分析  
3. **月次**: 品質メトリクス評価
4. **四半期**: 改善計画の見直し

---

## 📞 サポート・エスカレーション

**技術的課題**: 開発チームレビュー会議で解決  
**リソース不足**: プロジェクトマネージャーへエスカレーション  
**優先度変更**: ステークホルダーとの調整会議

---

*最終更新: 2024年12月*  
*作成者: Claude Code Assistant*  
*承認者: [記入してください]*