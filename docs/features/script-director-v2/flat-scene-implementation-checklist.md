# フラットシーン構造 実装チェックリスト

## Phase 1: データ構造とHooks（基盤）

### データ型定義
- [ ] `Scene`インターフェースの定義（types/index.ts）
- [ ] `SceneListState`インターフェースの定義
- [ ] `WorkflowMetadata`にsceneListフィールドを追加
- [ ] 幕（Act）関連の型定義を非推奨化

### Hooks実装
- [ ] `useSceneManager`フックの作成
  - [ ] シーンの追加機能
  - [ ] シーンの更新機能
  - [ ] シーンの削除機能
  - [ ] シーンの並び替え機能
  - [ ] バリデーション機能

### ユーティリティ関数
- [ ] `convertScenesToBeats`関数の実装（Scene → MulmoBeat変換）
- [ ] `convertBeatsToScenes`関数の実装（MulmoBeat → Scene変換）
- [ ] `generateSceneId`関数の実装
- [ ] `validateSceneList`関数の実装

## Phase 2: UIコンポーネント

### SceneListStepの更新
- [ ] 既存の幕・場UIを削除
- [ ] フラットなシーンリストUIの実装
- [ ] モバイルファーストのレイアウト適用

### SceneCardコンポーネント
- [ ] 基本的なカードUI
- [ ] インライン編集機能
- [ ] ドラッグハンドル（⋮）の実装
- [ ] 削除ボタン（スワイプまたは長押し）
- [ ] アニメーション効果

### インタラクション実装
- [ ] ドラッグ&ドロップ（react-beautiful-dndまたは自前実装）
- [ ] タッチジェスチャー対応
- [ ] キーボードナビゲーション
- [ ] アクセシビリティ対応

### 追加機能
- [ ] 「シーンを追加」ボタン
- [ ] シーン数カウンター表示
- [ ] 最大/最小シーン数の制約UI

## Phase 3: ワークフロー統合

### WorkflowContext更新
- [ ] sceneList状態の管理追加
- [ ] シーンデータの自動保存
- [ ] シーンデータのロード処理

### ステップ間の連携
- [ ] ステップ1（ストーリー入力）のtotal_scenesとの同期
- [ ] ステップ3（キャラクター設定）への影響確認
- [ ] ステップ4（台詞編集）でのシーン表示更新

## Phase 4: AI生成の更新

### プロンプト更新
- [ ] シーン番号ベースのプロンプト生成
- [ ] ユーザー設定のシーンタイトルを考慮
- [ ] フラット構造での台本生成

### API更新
- [ ] generateScreenplayエンドポイントの更新
- [ ] シーン情報の受け渡し
- [ ] レスポンス形式の調整

### MulmoScript統合
- [ ] Scene → Beat変換の実装
- [ ] Beat → Scene変換の実装
- [ ] 既存のMulmoScriptとの互換性確認
- [ ] テストケースの作成

## Phase 5: データ移行とテスト

### データ確認
- [ ] 既存のMulmoScriptデータがbeat形式であることを確認
- [ ] UIの表示調整のみで対応可能か確認
- [ ] 特別な移行処理は不要

### テスト実装
- [ ] useSceneManagerのユニットテスト
- [ ] SceneCardコンポーネントのテスト
- [ ] ドラッグ&ドロップのインテグレーションテスト
- [ ] E2Eテスト（Playwright）

### パフォーマンステスト
- [ ] 20シーンでのレンダリング性能
- [ ] ドラッグ&ドロップの応答性
- [ ] 自動保存の影響測定

## Phase 6: ドキュメントと最終調整

### ドキュメント更新
- [ ] ユーザーガイドの更新
- [ ] API仕様書の更新
- [ ] 移行ガイドの作成

### UI/UXの微調整
- [ ] アニメーションのタイミング調整
- [ ] エラーメッセージの改善
- [ ] ローディング状態の改善

### リリース準備
- [ ] フィーチャーフラグの設定
- [ ] 段階的ロールアウト計画
- [ ] モニタリング設定

## 見積もり工数

- Phase 1: 1日
- Phase 2: 2日
- Phase 3: 1日
- Phase 4: 1日
- Phase 5: 1日
- Phase 6: 0.5日

**合計: 約6.5日**

## リスクと対策

### リスク1: beatフィールドの扱い
- **対策**: MulmoScriptのbeat番号とUIのorder番号を正しくマッピング

### リスク2: 既存データの表示
- **対策**: beatデータを正しくScene形式に変換するロジックの実装

### リスク3: パフォーマンス低下
- **対策**: 仮想スクロールの検討、メモ化の活用

### リスク4: モバイルでのドラッグ&ドロップ
- **対策**: タッチ専用のライブラリ使用、代替UI（上下ボタン）の提供