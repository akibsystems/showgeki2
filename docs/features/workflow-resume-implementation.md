# ワークフロー再開機能の実装

## 概要

ワークフローを途中で離脱しても、後で同じステップから再開できる機能を実装しました。

## 実装内容

### Phase 1: 早期ドラフト作成システム ✅

1. **ドラフトAPI作成** (`/api/stories/draft`)
   - 最小限のデータでドラフトストーリーを作成
   - `workflow_state`を初期化（current_step: 1）
   - 作成後のストーリーIDを返却

2. **自動リダイレクト** (`/stories/new`)
   - アクセス時に即座にドラフトを作成
   - `/stories/[id]/new?step=1`へリダイレクト
   - エラー時は従来のフォームへフォールバック

### Phase 2: URL構造の改善 ✅

1. **ステップ番号のURL反映**
   - URLパラメータ: `?step=1`〜`?step=5`
   - ステップ変更時に自動的にURLを更新
   - ブラウザの戻る/進むボタンに対応

2. **直接アクセス対応**
   - `/stories/[id]/new`ページの作成
   - URLのステップ番号を読み取って適切なステップを表示
   - 不正なステップ番号の検証とリダイレクト

### Phase 3: UI/UX改善 ✅

1. **ダッシュボードでの表示**
   - 「作成中のワークフロー」セクションを追加
   - ステップ進捗の表示（ステップ 2/5）
   - 「続きから作成」ボタンで再開

2. **ワークフロードラフトの識別**
   - `status === 'draft' && workflow_state`で判定
   - 通常のドラフトと視覚的に区別
   - 現在のステップ名を表示

## 使用方法

### 1. 環境変数の設定

```bash
NEXT_PUBLIC_ENABLE_WORKFLOW_V2=true
```

### 2. 新規ワークフロー開始

`/stories/new`にアクセスすると：
1. 自動的にドラフトストーリーが作成される
2. `/stories/[id]/new?step=1`へリダイレクト
3. ワークフローが開始される

### 3. 再開方法

**方法1: ダッシュボードから**
- `/stories`にアクセス
- 「作成中のワークフロー」セクションを確認
- 「続きから作成」ボタンをクリック

**方法2: 直接URL**
- `/stories/[id]/new?step=[番号]`に直接アクセス

## データ構造

### ワークフロー状態の保存

```typescript
workflow_state: {
  current_step: number;        // 現在のステップ (1-5)
  completed_steps: number[];   // 完了したステップの配列
  metadata: {                  // ワークフロー固有のメタデータ
    scenes?: Scene[];          // フラットなシーン構造
  }
}
```

### 自動保存のタイミング

- 各フィールドの変更時（2秒のdebounce）
- ステップ完了時
- ナビゲーション時

## テスト方法

```bash
# テストスクリプトの実行
node scripts/test-workflow-resume.js

# 手動テスト
1. NEXT_PUBLIC_ENABLE_WORKFLOW_V2=true を設定
2. /stories/new にアクセス
3. ステップ1でストーリーを入力
4. ステップ2へ進む
5. ブラウザを閉じる
6. /stories ダッシュボードから「続きから作成」をクリック
7. ステップ2から再開されることを確認
```

## 今後の改善点

### Phase 4: メンテナンス機能（未実装）

- [ ] 30日以上古いワークフロードラフトの自動削除
- [ ] 削除前の通知機能
- [ ] アーカイブ機能

### その他の改善案

- [ ] 自動保存インジケーターの追加
- [ ] オフライン対応（LocalStorage活用）
- [ ] 複数デバイス間での同期
- [ ] 作業時間の記録と表示