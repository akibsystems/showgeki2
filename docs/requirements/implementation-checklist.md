# mulmocast GUI PoC 実装チェックリスト

## 📋 概要

このチェックリストは実装フェーズごとに整理された、ファイル単位の詳細タスクリストです。
各タスクには優先度、推定工数、依存関係が記載されています。

**凡例:**
- 🔴 **Critical**: 他の機能をブロックする重要な実装
- 🟡 **High**: 主要機能の実装
- 🟢 **Medium**: 機能強化・UX改善
- 🔵 **Low**: 最適化・将来的な拡張

**推定工数**: S(1-2h), M(0.5-1d), L(1-3d), XL(3-5d)

---

## Phase 1: 基盤構築 🏗️

### 1.1 データベースマイグレーション

#### 🔴 データベーススキーマ作成（既存削除→新規作成）
- **ファイル**: `src/lib/database-migration.sql`
- **内容**: 既存テーブル削除 + 新スキーマで全テーブル再作成
- **工数**: M
- **依存**: なし
- **チェック項目**:
  - [ ] 既存 `stories`, `reviews` テーブル削除 (CASCADE)
  - [ ] `workspaces` テーブル作成 (`id`, `uid`, `name`, `created_at`)
  - [ ] `stories` テーブル新規作成 (`id`, `workspace_id`, `uid`, `title`, `text_raw`, `script_json`, `status`, `created_at`, `updated_at`)
  - [ ] `videos` テーブル作成 (`id`, `story_id`, `uid`, `url`, `duration_sec`, `resolution`, `size_mb`, `status`, `error_msg`, `created_at`)
  - [ ] `reviews` テーブル再作成 (既存互換)
  - [ ] 適切なインデックス・制約・CHECK制約作成
  - [ ] RLS ポリシー設定
  - [ ] `updated_at` 自動更新トリガー作成
  - [ ] サンプルデータ投入

#### 🔴 Supabase クライアント設定更新
- **ファイル**: `src/lib/supabase.ts`
- **内容**: Service Role 設定、型定義更新
- **工数**: S
- **依存**: データベーススキーマ更新
- **チェック項目**:
  - [ ] Service Role Key 環境変数設定
  - [ ] 管理者用クライアント作成
  - [ ] 既存型定義を新スキーマに更新
  - [ ] RLS ポリシー確認・更新

### 1.2 型定義・スキーマ定義

#### 🔴 Zod スキーマ定義
- **ファイル**: `src/lib/schemas.ts`
- **内容**: 全データモデルのZodスキーマ定義
- **工数**: M
- **依存**: データベーススキーマ
- **チェック項目**:
  - [ ] `UidSchema` - UUID バリデーション
  - [ ] `WorkspaceSchema` - ワークスペース型定義
  - [ ] `StorySchema` - ストーリー型定義 (status enum含む)
  - [ ] `VideoSchema` - 動画型定義
  - [ ] `MulmoscriptSchema` - mulmoscript JSON構造定義
  - [ ] API リクエスト/レスポンス用スキーマ
  - [ ] バリデーションエラーハンドリング

#### 🔴 TypeScript 型定義
- **ファイル**: `src/types/index.ts`
- **内容**: Zod から型生成、共通型定義
- **工数**: S
- **依存**: Zod スキーマ
- **チェック項目**:
  - [ ] Zod スキーマから TypeScript 型生成
  - [ ] API レスポンス型定義
  - [ ] フロントエンド状態管理用型定義
  - [ ] エラー型定義

### 1.3 認証・UID管理

#### 🔴 UID管理ユーティリティ
- **ファイル**: `src/lib/uid.ts`
- **内容**: localStorage ベース匿名認証
- **工数**: S
- **依存**: なし
- **チェック項目**:
  - [ ] `getOrCreateUid()` - UID取得/生成
  - [ ] `clearUid()` - UID削除
  - [ ] `isValidUid()` - UID検証
  - [ ] Cookie フォールバック対応
  - [ ] SSR 対応 (window チェック)

#### 🔴 認証ミドルウェア
- **ファイル**: `src/lib/auth.ts`
- **内容**: API Route用認証機能
- **工数**: S
- **依存**: UID管理ユーティリティ
- **チェック項目**:
  - [ ] `extractUid()` - リクエストからUID抽出
  - [ ] `validateUid()` - UID検証
  - [ ] `authMiddleware()` - API Route用ミドルウェア
  - [ ] エラーハンドリング

#### 🔴 APIクライアント基盤
- **ファイル**: `src/lib/api-client.ts`
- **内容**: 統一されたAPI呼び出しクライアント
- **工数**: M
- **依存**: UID管理、型定義
- **チェック項目**:
  - [ ] `ApiClient` クラス実装
  - [ ] 自動UID付与機能
  - [ ] エラーハンドリング
  - [ ] 型安全なAPI呼び出し
  - [ ] レスポンスキャッシュ機能

---

## Phase 2: コア機能実装 ⚙️

### 2.1 ワークスペース管理

#### 🔴 ワークスペース API Routes
- **ファイル**: `src/app/api/workspaces/route.ts`
- **内容**: ワークスペース CRUD API
- **工数**: M
- **依存**: 認証ミドルウェア、スキーマ定義
- **チェック項目**:
  - [ ] `GET /api/workspaces` - 一覧取得
  - [ ] `POST /api/workspaces` - 新規作成
  - [ ] UID によるデータ隔離
  - [ ] バリデーション (Zod)
  - [ ] エラーハンドリング
  - [ ] デフォルトワークスペース自動作成

#### 🟡 ワークスペース詳細 API
- **ファイル**: `src/app/api/workspaces/[id]/route.ts`
- **内容**: 個別ワークスペース操作
- **工数**: S
- **依存**: ワークスペース API
- **チェック項目**:
  - [ ] `GET /api/workspaces/[id]` - 詳細取得
  - [ ] `PUT /api/workspaces/[id]` - 更新
  - [ ] `DELETE /api/workspaces/[id]` - 削除
  - [ ] 権限チェック (UID一致)

### 2.2 ストーリー管理

#### 🔴 ストーリー API Routes 拡張
- **ファイル**: `src/app/api/stories/route.ts` (既存拡張)
- **内容**: 既存 API を新スキーマ対応
- **工数**: M
- **依存**: 新しいスキーマ定義
- **チェック項目**:
  - [ ] 既存エンドポイントを新スキーマに移行
  - [ ] `workspace_id` パラメータ対応
  - [ ] `uid` によるデータ隔離
  - [ ] ページネーション対応
  - [ ] フィルタリング機能 (status, date)
  - [ ] 既存データとの後方互換性

#### 🔴 ストーリー詳細 API 拡張
- **ファイル**: `src/app/api/stories/[id]/route.ts` (既存拡張)
- **内容**: 個別ストーリー操作の拡張
- **工数**: M
- **依存**: ストーリーAPI拡張
- **チェック項目**:
  - [ ] `GET` - 詳細取得 (script_json 含む)
  - [ ] `PUT` - 更新 (title, text_raw, script_json)
  - [ ] `DELETE` - 削除 (関連動画も削除)
  - [ ] 権限チェック (UID一致)
  - [ ] 楽観的ロック対応 (updated_at)

### 2.3 スクリプト生成機能

#### 🔴 スクリプト生成 API
- **ファイル**: `src/app/api/stories/[id]/generate-script/route.ts`
- **内容**: LLM によるスクリプト自動生成
- **工数**: L
- **依存**: OpenAI API、mulmoscript スキーマ
- **チェック項目**:
  - [ ] `POST /api/stories/[id]/generate-script`
  - [ ] OpenAI API 統合
  - [ ] プロンプトエンジニアリング
  - [ ] mulmoscript JSON バリデーション
  - [ ] 生成結果の `script_json` 保存
  - [ ] エラーハンドリング (API制限、形式エラー等)
  - [ ] レート制限対応

#### 🟡 プロンプトテンプレート管理
- **ファイル**: `src/lib/prompt-templates.ts`
- **内容**: LLM用プロンプト管理
- **工数**: S
- **依存**: なし
- **チェック項目**:
  - [ ] ストーリー→mulmoscript 変換プロンプト
  - [ ] プロンプトバリエーション管理
  - [ ] テンプレート変数置換機能
  - [ ] プロンプト性能測定用ログ

---

## Phase 3: 高度な機能実装 🚀

### 3.1 Monaco Editor 統合

#### 🟡 Monaco Editor コンポーネント
- **ファイル**: `src/components/monaco-editor.tsx`
- **内容**: mulmoscript 編集用エディタ
- **工数**: L
- **依存**: Monaco Editor パッケージ
- **チェック項目**:
  - [ ] Monaco Editor React コンポーネント
  - [ ] JSON スキーマバリデーション連携
  - [ ] シンタックスハイライト (mulmoscript用)
  - [ ] 自動補完機能
  - [ ] エラー表示・行ハイライト
  - [ ] `Ctrl+S` 自動保存対応
  - [ ] リサイズ対応

#### 🟡 エディタ設定・テーマ
- **ファイル**: `src/lib/monaco-config.ts`
- **内容**: Monaco Editor 設定管理
- **工数**: S
- **依存**: Monaco Editor コンポーネント
- **チェック項目**:
  - [ ] エディタ基本設定 (フォント、テーマ等)
  - [ ] mulmoscript 用言語定義
  - [ ] カスタムテーマ定義
  - [ ] キーボードショートカット設定

### 3.2 動画生成機能

#### 🔴 動画生成 API
- **ファイル**: `src/app/api/stories/[id]/generate-video/route.ts`
- **内容**: Cloud Run Jobs トリガー
- **工数**: L
- **依存**: Cloud Run Jobs 設定
- **チェック項目**:
  - [ ] `POST /api/stories/[id]/generate-video`
  - [ ] Cloud Run Jobs HTTP トリガー
  - [ ] `videos` テーブルレコード作成
  - [ ] ジョブパラメータ設定
  - [ ] エラーハンドリング
  - [ ] レート制限 (同時実行数制御)

#### 🟡 動画ステータス管理 API
- **ファイル**: `src/app/api/videos/[id]/status/route.ts`
- **内容**: 動画生成進捗確認
- **工数**: S
- **依存**: 動画生成 API
- **チェック項目**:
  - [ ] `GET /api/videos/[id]/status`
  - [ ] 進捗情報取得 (Cloud Run Jobs API)
  - [ ] 完了時URL取得・保存
  - [ ] 失敗時エラー情報取得・保存

#### 🟡 動画管理 API
- **ファイル**: `src/app/api/videos/route.ts`
- **内容**: 動画一覧・削除機能
- **工数**: M
- **依存**: 動画生成 API
- **チェック項目**:
  - [ ] `GET /api/videos` - 一覧取得
  - [ ] `DELETE /api/videos/[id]` - 削除
  - [ ] Supabase Storage ファイル削除連携
  - [ ] フィルタ・ソート機能
  - [ ] メタデータ取得

---

## Phase 4: フロントエンド実装 🎨

### 4.1 共通コンポーネント

#### 🟡 レイアウトコンポーネント
- **ファイル**: `src/components/layout/app-layout.tsx`
- **内容**: アプリケーション共通レイアウト
- **工数**: M
- **依存**: 状態管理
- **チェック項目**:
  - [ ] ヘッダー・サイドバー・メインエリア
  - [ ] ワークスペース選択UI
  - [ ] ナビゲーションメニュー
  - [ ] レスポンシブ対応
  - [ ] ローディング状態表示

#### 🟡 共通UIコンポーネント
- **ファイル**: `src/components/ui/` (複数ファイル)
- **内容**: 再利用可能UIコンポーネント
- **工数**: M
- **依存**: Tailwind CSS
- **チェック項目**:
  - [ ] `Button` - 汎用ボタン
  - [ ] `Modal` - モーダルダイアログ
  - [ ] `Spinner` - ローディング表示
  - [ ] `Toast` - 通知表示
  - [ ] `Dropdown` - ドロップダウンメニュー
  - [ ] `Card` - カードコンポーネント

### 4.2 主要ページコンポーネント

#### 🔴 Dashboard ページ
- **ファイル**: `src/app/dashboard/page.tsx`
- **内容**: メインダッシュボード
- **工数**: L
- **依存**: APIクライアント、共通コンポーネント
- **チェック項目**:
  - [ ] ワークスペース選択・切替
  - [ ] ストーリーカード一覧表示
  - [ ] 新規ストーリー作成ボタン・モーダル
  - [ ] 検索・フィルタ機能
  - [ ] グリッド・リスト表示切替
  - [ ] 無限スクロール/ページネーション

#### 🔴 Story Editor ページ
- **ファイル**: `src/app/stories/[id]/page.tsx`
- **内容**: ストーリー編集画面
- **工数**: XL
- **依存**: Monaco Editor、APIクライアント
- **チェック項目**:
  - [ ] 左右分割レイアウト
  - [ ] 左側: ストーリーテキスト入力エリア
  - [ ] 右側: Monaco Editor (mulmoscript)
  - [ ] 下部: アクションバー
  - [ ] スクリプト生成ボタン・進捗表示
  - [ ] 自動保存機能
  - [ ] バリデーションエラー表示
  - [ ] 実行ボタン・動画生成開始

#### 🟡 Video Manager ページ
- **ファイル**: `src/app/videos/page.tsx`
- **内容**: 動画一覧・管理画面
- **工数**: L
- **依存**: 動画API、プレーヤー
- **チェック項目**:
  - [ ] 動画一覧表示 (グリッド/リスト)
  - [ ] フィルタ・ソート機能
  - [ ] 動画プレーヤー (モーダル)
  - [ ] メタデータ表示
  - [ ] 削除機能
  - [ ] 生成進捗表示
  - [ ] サムネイル生成・表示

### 4.3 状態管理

#### 🔴 Context API 実装
- **ファイル**: `src/contexts/app-context.tsx`
- **内容**: アプリケーション状態管理
- **工数**: M
- **依存**: APIクライアント
- **チェック項目**:
  - [ ] `AppContext` - アプリケーション全体状態
  - [ ] `WorkspaceContext` - ワークスペース状態
  - [ ] `StoryContext` - ストーリー編集状態
  - [ ] 状態の永続化 (localStorage)
  - [ ] 楽観的更新対応

#### 🟡 SWR データフェッチング
- **ファイル**: `src/hooks/use-*.ts` (複数ファイル)
- **内容**: データフェッチング用カスタムフック
- **工数**: M
- **依存**: SWR、APIクライアント
- **チェック項目**:
  - [ ] `useWorkspaces` - ワークスペース一覧
  - [ ] `useStories` - ストーリー一覧
  - [ ] `useStory` - 個別ストーリー
  - [ ] `useVideos` - 動画一覧
  - [ ] `useVideoStatus` - 動画生成状況
  - [ ] エラーハンドリング・リトライ

---

## Phase 5: エラーハンドリング・最適化 🛡️

### 5.1 エラーハンドリング

#### 🟡 エラー管理システム
- **ファイル**: `src/lib/errors.ts`
- **内容**: 統一エラーハンドリング
- **工数**: S
- **依存**: なし
- **チェック項目**:
  - [ ] `AppError` クラス定義
  - [ ] エラー分類 (enum)
  - [ ] エラーログ機能
  - [ ] ユーザー向けエラーメッセージ変換

#### 🟡 エラーバウンダリ
- **ファイル**: `src/components/error-boundary.tsx`
- **内容**: React エラーバウンダリ
- **工数**: S
- **依存**: エラー管理システム
- **チェック項目**:
  - [ ] 全画面エラーバウンダリ
  - [ ] ページレベルエラーバウンダリ
  - [ ] エラー報告機能
  - [ ] フォールバックUI

### 5.2 パフォーマンス最適化

#### 🟢 コード分割・遅延読み込み
- **ファイル**: 各ページコンポーネント
- **内容**: バンドルサイズ最適化
- **工数**: S
- **依存**: 全ページ実装完了
- **チェック項目**:
  - [ ] ページレベル動的インポート
  - [ ] Monaco Editor 遅延読み込み
  - [ ] 重いライブラリの動的読み込み
  - [ ] 画像の最適化・遅延読み込み

#### 🟢 キャッシュ戦略
- **ファイル**: `src/lib/cache.ts`
- **内容**: クライアントサイドキャッシュ
- **工数**: S
- **依存**: SWR設定
- **チェック項目**:
  - [ ] SWR キャッシュ設定最適化
  - [ ] localStorage キャッシュ
  - [ ] API レスポンスキャッシュ
  - [ ] 画像キャッシュ設定

---

## Phase 6: テスト・品質保証 🧪

### 6.1 単体テスト

#### 🟢 コンポーネントテスト
- **ファイル**: `src/**/__tests__/*.test.tsx`
- **内容**: React コンポーネント単体テスト
- **工数**: M
- **依存**: テスト環境設定
- **チェック項目**:
  - [ ] 主要コンポーネントのレンダリングテスト
  - [ ] ユーザーインタラクションテスト
  - [ ] プロパティ・状態変更テスト
  - [ ] エラー状態テスト

#### 🟢 API テスト
- **ファイル**: `src/app/api/**/__tests__/*.test.ts`
- **内容**: API Routes 単体テスト
- **工数**: M
- **依存**: テスト環境設定
- **チェック項目**:
  - [ ] 正常系レスポンステスト
  - [ ] バリデーションエラーテスト
  - [ ] 認証エラーテスト
  - [ ] データベース操作テスト

### 6.2 E2E テスト

#### 🟢 主要ユーザーフローテスト
- **ファイル**: `tests/e2e/*.spec.ts`
- **内容**: Playwright E2E テスト
- **工数**: L
- **依存**: 全機能実装完了
- **チェック項目**:
  - [ ] 初回ユーザー登録〜ワークスペース作成
  - [ ] ストーリー作成〜スクリプト生成
  - [ ] スクリプト編集〜保存
  - [ ] 動画生成〜視聴
  - [ ] エラーケース対応テスト

---

## Phase 7: デプロイ・運用準備 🚀

### 7.1 環境設定

#### 🔴 環境変数・設定管理
- **ファイル**: `.env.example`, `next.config.ts`
- **内容**: 本番環境設定
- **工数**: S
- **依存**: なし
- **チェック項目**:
  - [ ] 環境変数一覧・サンプル作成
  - [ ] Next.js 設定最適化
  - [ ] Vercel デプロイ設定
  - [ ] Supabase 本番環境設定
  - [ ] Cloud Run Jobs 設定

#### 🟡 監視・ログ設定
- **ファイル**: `src/lib/monitoring.ts`
- **内容**: 運用監視設定
- **工数**: S
- **依存**: 本番環境
- **チェック項目**:
  - [ ] 構造化ログ実装
  - [ ] エラー監視設定
  - [ ] 性能監視設定
  - [ ] アラート設定

---

## 📊 実装優先度マトリックス

| フェーズ | Critical | High | Medium | Low | 合計工数 |
|---------|----------|------|--------|-----|----------|
| Phase 1 | 4件 (M+S+M+S) | 0件 | 0件 | 0件 | ~1.5d |
| Phase 2 | 4件 (M+M+M+L) | 1件 (S) | 0件 | 0件 | ~3d |
| Phase 3 | 1件 (L) | 3件 (L+S+M) | 0件 | 0件 | ~2.5d |
| Phase 4 | 3件 (L+XL+M) | 0件 | 1件 (M) | 0件 | ~4d |
| Phase 5 | 0件 | 2件 (S+S) | 2件 (S+S) | 0件 | ~0.5d |
| Phase 6 | 0件 | 0件 | 3件 (M+M+L) | 0件 | ~2d |
| Phase 7 | 1件 (S) | 1件 (S) | 0件 | 0件 | ~0.5d |

**総推定工数: 約14-16日**

---

## 🎯 実装開始時の推奨順序

1. **最優先**: Phase 1 の Critical タスク → 基盤を固める
2. **第2優先**: Phase 2 の Critical タスク → コア機能実装
3. **第3優先**: Phase 4 の Critical タスク → ユーザーが触れる機能
4. **並行実装**: Phase 3 の高度な機能 → スペシャリストが担当
5. **仕上げ**: Phase 5-7 → 品質・運用準備

この順序で実装することで、早期に動作するプロトタイプを作成し、段階的に機能を拡張できます。